# NixOS Frost Peak - System Configuration

## Hardware

| Component | Details |
|-----------|---------|
| CPU | AMD Ryzen 9 7900X (12c/24t) + integrated Radeon iGPU |
| GPU | AMD XFX RX 7900 XT (RDNA 3, open-source amdgpu driver) |
| RAM | 32GB DDR5 |
| Kernel | Xanmod (latest) |
| Display 1 | Samsung LC49G95T 5120x1440@120Hz (DP-2, primary ultrawide) |
| Display 2 | Samsung LC34G55T 3440x1440@100Hz (DP-3, vertical/rotated 90) |
| Storage | LUKS-encrypted NVMe (root + home + swap) |
| OS | NixOS 26.05 (unstable) |

## Architecture

```
~/nix-config  (symlink -> Nextcloud repo)
|
+-- flake.nix                     Entry point: pins nixpkgs + home-manager
|
+-- configuration.nix             System config: boot, NVIDIA, services, packages
|     +-- hardware-configuration.nix   Auto-generated hardware config
|     +-- gdm-theme/                   GDM Frost Peak assets
|
+-- home/default.nix              User config: programs, dotfile symlinks, scripts
      +-- config/*                Dotfiles (live-editable via mkOutOfStoreSymlink)
      +-- thunderbird/*           Thunderbird CSS (live-editable)
      +-- local/bin/*             Scripts (live-editable)
```

### What requires a rebuild

Changes to these files require `nrs` (nixos-rebuild switch):

- `configuration.nix` - System packages, services, boot params, NVIDIA
- `home/default.nix` - HM programs (kitty colors, fish abbrs, starship, GTK theme, VSCode extensions)
- `flake.nix` - Flake inputs

### What is live-editable (no rebuild)

These files are symlinked directly from the repo via `mkOutOfStoreSymlink`:

- `config/niri/` - Niri compositor config (reload: `Mod+Ctrl+R`)
- `config/waybar/` - Status bar (restart waybar to apply)
- `config/mako/` - Notifications
- `config/fuzzel/` - App launcher
- `config/swaylock/` - Lock screen
- `config/swayidle/` - Idle management
- `config/cava/` - Audio visualizer
- `config/fastfetch/` - System info display
- `config/yazi/` - File manager theme
- `config/alacritty/` - Alternative terminal
- `thunderbird/` - Thunderbird CSS theming
- `local/bin/` - Custom scripts (night-mode, screenrecord, toggle-mode, webapp-*, backup, zoho-workdrive)

## Daily Workflow

### Rebuild system (after editing .nix files)

```fish
nrs    # expands to: sudo nixos-rebuild switch --flake ~/nix-config#nixos
```

### Test without making permanent (rolls back on next boot)

```fish
nrt    # expands to: sudo nixos-rebuild test --flake ~/nix-config#nixos
```

### Update all packages

```fish
cd ~/nix-config
nix flake update          # Updates flake.lock (nixpkgs + home-manager)
nrs                       # Rebuild with new versions
```

### Update a single input

```fish
cd ~/nix-config
nix flake update home-manager   # Update only home-manager
nrs
```

### Edit dotfiles (no rebuild needed)

```fish
# Edit niri config and reload
vim ~/nix-config/config/niri/config.kdl
# Press Mod+Ctrl+R to reload niri config

# Edit waybar
vim ~/nix-config/config/waybar/style.css
# Restart waybar: killall waybar && waybar &
```

### Roll back

```fish
sudo nixos-rebuild switch --rollback    # Previous generation
# Or pick a specific generation from boot menu
```

## Symlink Chain

```
~/.config/niri
  -> /nix/store/.../home-manager-files/.config/niri  (HM generation)
    -> /nix/store/.../hm_niri                         (mkOutOfStoreSymlink derivation)
      -> /home/kaika/nix-config/config/niri            (actual repo files)
```

The `~/nix-config` symlink itself resolves to the Nextcloud-synced repo:
```
~/nix-config -> /home/kaika/Nextcloud/06 - DEV/06 - Linux Config/Nix Config
```

## File Reference

| File | Purpose |
|------|---------|
| `flake.nix` | Flake entry point. Pins nixpkgs (unstable) and home-manager. Defines `nixosConfigurations.nixos` |
| `flake.lock` | Auto-generated. Pinned versions of all inputs. Commit this file |
| `configuration.nix` | System-level NixOS config (~710 lines). Boot, kernel, NVIDIA, GDM, services, packages, security |
| `hardware-configuration.nix` | Auto-generated by `nixos-generate-config`. LUKS devices, filesystems, CPU microcode |
| `home/default.nix` | Home Manager config (~500 lines). Programs, dotfile symlinks, GTK/Qt theme, XDG, scripts |
| `gdm-theme/frost-peak-overrides.css` | CSS injected into GDM's gnome-shell gresource |
| `gdm-theme/frost-peak-logo.svg` | Logo displayed on GDM login screen |
| `gdm-theme/wallpaper.jpg` | GDM login wallpaper (Frost Peak mountains) |
| `config/niri/config.kdl` | Niri compositor config. Outputs, layout, keybindings, window rules |
| `config/waybar/config` | Waybar layout (workspaces, clock, audio, network) |
| `config/waybar/style.css` | Waybar theme CSS |

## Theme: Frost Peak

| Token | Color | Usage |
|-------|-------|-------|
| Primary | `#38bdf8` | Ice blue. Focus rings, accents, cursor, prompts |
| Secondary | `#a78bfa` | Violet. Git branch, per-module accents |
| Warm | `#f59e0b` | Amber. Warnings, modified files |
| Background | `#0c0e14` | Near-black. Window backgrounds |
| Surface | `#141620` | Slightly lighter. Cards, inactive borders |
| Border | `#262a3a` | Subtle borders, separators |
| Text | `#e0e6f0` | Light gray. Primary text color |

### Color reference (terminals)

| ANSI | Normal | Bright |
|------|--------|--------|
| Black | `#262a3a` | `#3a3f52` |
| Red | `#f87171` | `#fca5a5` |
| Green | `#34d399` | `#6ee7b7` |
| Yellow | `#f59e0b` | `#fbbf24` |
| Blue | `#38bdf8` | `#7dd3fc` |
| Magenta | `#a78bfa` | `#c4b5fd` |
| Cyan | `#22d3ee` | `#67e8f9` |
| White | `#e0e6f0` | `#ffffff` |

## Keybindings (Niri)

### Core

| Key | Action |
|-----|--------|
| `Mod+Space` | Fuzzel launcher |
| `Mod+Return` | Kitty terminal |
| `Mod+W` | Close window |
| `Mod+F` | Fullscreen |
| `Mod+O` | Toggle floating |
| `Mod+Alt+F` | Maximize column |
| `Mod+Escape` | Quit niri |
| `Mod+Ctrl+R` | Reload niri config |

### Workspaces

| Key | Action |
|-----|--------|
| `Mod+1-9` | Focus workspace 1-9 |
| `Mod+Shift+1-9` | Move window to workspace 1-9 |
| `Mod+Tab` | Next workspace |
| `Mod+Shift+Tab` | Previous workspace |

### Focus & Move (Arrow or Vim keys)

| Key | Action |
|-----|--------|
| `Mod+H/Left` | Focus left |
| `Mod+J/Down` | Focus down |
| `Mod+K/Up` | Focus up |
| `Mod+L/Right` | Focus right |
| `Mod+Shift+H/Left` | Move window left |
| `Mod+Shift+J/Down` | Move window down |

### Apps

| Key | Action |
|-----|--------|
| `Mod+Shift+B` | Brave browser |
| `Mod+Shift+N` | VS Code |
| `Mod+Shift+O` | Obsidian |
| `Mod+Shift+M` | Spotify |
| `Mod+Shift+F` | Thunar |
| `Mod+E` | Yazi (TUI file manager) |
| `Mod+Shift+D` | Lazygit |
| `Mod+Ctrl+T` | btop |
| `Mod+Shift+C` | Cava visualizer |
| `Mod+Shift+Slash` | Bitwarden |

### System

| Key | Action |
|-----|--------|
| `Mod+Ctrl+A` | Audio (pavucontrol) |
| `Mod+Ctrl+B` | Bluetooth |
| `Mod+Ctrl+W` | WiFi |
| `Mod+Ctrl+L` | Lock screen |
| `Mod+Ctrl+N` | Night mode toggle |
| `Mod+Shift+V` | Vibe/Focus mode toggle |
| `Mod+Shift+S` | Screenshot (selection) |
| `Mod+Ctrl+V` | Clipboard history |

## GPU Notes

### AMD RX 7900 XT (current)
- Uses open-source `amdgpu` kernel driver + Mesa userspace — no proprietary driver needed
- VA-API hardware video acceleration works out of the box via `radeonsi`
- VRR should work properly with AMD + Niri (can be enabled in niri config if desired)
- No GPU clock locking or power management hacks needed
- No `debug { render-drm-device }` needed in niri — only one dGPU, auto-detected

### Previous NVIDIA notes (archived)
- PCIe ASPM caused multi-second GPU stalls — was disabled with `pcie_aspm=off`
- GPU dropped to P8/210MHz idle causing wake-up stalls — required clock locking
- VRR caused flickering on NVIDIA+Niri
- Required `render-drm-device "/dev/dri/card1"` to prevent iGPU rendering
- NVIDIA application profile `GLVidHeapReuseRatio=0` was needed for VRAM management

## Adding New Dotfiles

To add a new app's config to the repo:

1. Create the config directory in `config/`:
   ```bash
   mkdir ~/nix-config/config/newapp
   cp ~/.config/newapp/config ~/nix-config/config/newapp/
   ```

2. Add the symlink in `home/default.nix`:
   ```nix
   xdg.configFile = {
     # ... existing entries ...
     "newapp".source = config.lib.file.mkOutOfStoreSymlink "${dotfilesPath}/config/newapp";
   };
   ```

3. Remove the existing config and rebuild:
   ```bash
   rm -rf ~/.config/newapp
   nrs
   ```

## Adding New Scripts

1. Add the script to `local/bin/`:
   ```bash
   cp my-script ~/nix-config/local/bin/my-script
   chmod +x ~/nix-config/local/bin/my-script
   ```

2. Add the symlink in `home/default.nix`:
   ```nix
   home.file = {
     # ... existing entries ...
     ".local/bin/my-script".source = config.lib.file.mkOutOfStoreSymlink "${dotfilesPath}/local/bin/my-script";
   };
   ```

3. Rebuild: `nrs`

## Fresh Machine Setup

1. Boot NixOS installer, partition, and install minimal system
2. Clone this repo: `git clone <url> ~/nix-config`
3. Copy hardware config: `cp /etc/nixos/hardware-configuration.nix ~/nix-config/`
4. Copy wallpaper: `cp /path/to/wallpaper.jpg ~/nix-config/gdm-theme/wallpaper.jpg`
5. Enable flakes: `nix-shell -p nixVersions.latest --run "nix build ~/nix-config#nixosConfigurations.nixos.config.system.build.toplevel"`
6. Switch: `sudo nixos-rebuild switch --flake ~/nix-config#nixos`
7. Reboot and log into niri via GDM

## Fish Abbreviations

| Abbr | Expands to |
|------|-----------|
| `nrs` | `sudo nixos-rebuild switch --flake ~/nix-config#nixos` |
| `nrt` | `sudo nixos-rebuild test --flake ~/nix-config#nixos` |
| `g` | `git` |
| `ga` | `git add` |
| `gc` | `git commit` |
| `gp` | `git push` |
| `gs` | `git status` |
| `gd` | `git diff` |
| `gl` | `git log` |
| `cat` | `bat` |
| `ls` | `eza` |
| `ll` | `eza -l` |
| `la` | `eza -la` |
| `tree` | `eza --tree` |
| `cd` | `z` (zoxide) |
